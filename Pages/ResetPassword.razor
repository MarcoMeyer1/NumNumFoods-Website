@page "/reset-password"
@inject HttpClient Http
@inject NavigationManager Navigation
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.WebUtilities

<h3>Reset Password</h3>

@if (string.IsNullOrEmpty(token))
{
    <p>Invalid token.</p>
}
else if (!string.IsNullOrEmpty(message))
{
    <p>@message</p>
}
else
{
    <EditForm Model="model" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div>
            <label>New Password:</label>
            <InputText @bind-Value="model.NewPassword" type="password" />
        </div>

        <button type="submit">Reset Password</button>
    </EditForm>
}

@code {
    private string token;
    private ResetPasswordRequest model = new ResetPasswordRequest();
    private string message;

    protected override void OnInitialized()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("token", out var tokenValue))
        {
            token = tokenValue;
            model.Token = token;
        }
        else
        {
            token = null;
        }
    }

    private async Task HandleValidSubmit()
    {
        var response = await Http.PostAsJsonAsync("https://numnumfoods-api.azurewebsites.net/api/account/reset-password", model);
        if (response.IsSuccessStatusCode)
        {
            message = "Your password has been reset successfully.";
            // Optionally redirect to login page
            // Navigation.NavigateTo("/login");
        }
        else
        {
            var errorContent = await response.Content.ReadAsStringAsync();
            message = $"Error: {errorContent}";
        }
    }

    public class ResetPasswordRequest
    {
        public string Token { get; set; }
        public string NewPassword { get; set; }
    }
}
